\documentclass[../Thesis.tex]{subfiles}
\graphicspath{{\subfix{../figures/}}}
\begin{document}

\chapter{Data}\label{chap:data}
In this chapter, we will introduce the pharmaceutical production data, that we shall later use to infer a causal structure pertaining different parts of the production system. In particular, as we are interested in the duration and amount of produced substance during the production flow, these are highly relevant attributes of the processes that make up the production. Hence, we will start this chapter with an overview of the production system, how the observations are structured and created to begin with. For the rest of the chapter, we will concern ourselves with analysis of the production system such as basic statistics, incomplete or wrongly labelled observations and initial observations about codependency (which is very relevant when studying causality).

The observations that we will ultimately use for the causal study is simulated by \cite{benchmark-model-to-generate-batch-process-data}. However, before diving into how these simulations were carried out, we present the overall structure of the simulated observations and the production system they are supposed to originate from. Namely, a set of $6$ cycles, where each cycle consists of a set of batches executed one by one. Thus, as cycle is simply a notion for multiple batches that are executed in continuation of each other. In particular, different settings for the simulation of each cycle have been used to encompass multiple scenarios of how the production system can function. We note that although the cycles are generated from different settings, they are still representative of the same production system. Hence, we shall later combine observations from all cycles.

A batch refers to a collection of processes/unit $\mathcal{U}$ that need to be executed in some order to produce a product. In particular, for this simulation study, each batch is a collection of the processes depicted in \autoref{fig:Cycle and process structure}.
\begin{figure}[ht]
    \centering
    \includegraphics[width=.9\linewidth]{figures/Multiple cycles data/Cycle production layout.png}
    \caption{The structure of a single cycle. A cycle comprises $n_c$ batches that are carried out one by one. Thus, a cycle is simply a collection of a complex task (a batch), that need to be repeated $n_c$ times. The number of times is often based on time or amount of produced drug or substance, such that a cycle is terminated after these criterions are met. We shall later see that in the case of this simulation study, $n_c$ is determined from the accumulated duration of the batches i.e. after a certain amount of time has been simulated, the simulation is terminated. The structure of each batch is observed in the lower part of the figure and consists of $11$ main processes such as addition of solids and chemicals (processes labeled with ID $1$ through $4$). Each process can be made up of a number of \textit{subprocesses} such as the subprocess with ID $4.3$, where the batch waits for a control operator before proceeding.}
    \label{fig:Cycle and process structure}
\end{figure}

For each cycle, we then have a time series, where the ID of the batch is given as well as sensory values. The sensors measure the level of the tank (percentage of mow much of the tank is filled), the height (equivalent to the level), the RPM of a motor that circulates the contents of the tank, the cooling water flow (specifically for the cooling process with ID 9) and the steam flow during the reaction process. We shall however restrict ourselves to only using the level sensor in this thesis but including the other variables could improve on our results later on. We have chosen only the level as it is assumed to be the most descriptive of how much product is eventually produced.

In \autoref{fig:variable description} an example of the temporal evolution of a process is shown (with the previous process as well). We define $T^P_u$ to be the duration of the process/unit operation $u$ and equivalently $M^P_u$ to be the \textit{change} in level during process $u$. Not that we have also defined random variables $T^D_u$ and $M^D_u$. Why we need these will become apparent in \autoref{sec:Data - production processes} but for now we note that they correspond to delays after each of the processes. In particular, after a process is completed, the might be some downtime in the production system due to unforeseen reasons. We shall later see that for some processes, the delays will not influence the level of the tank whereas the reverse is true for other processes such as the reaction (labelled $7$).

\begin{figure}[ht]
    \centering
    \includegraphics[width=.7\linewidth]{figures/Multiple cycles data/variable desciption.png}
    \caption{Exemplification of the evolution of the level in a tank during a process $u$ and the previous process. The variables $T_u^P$, $T^D_u$, $M_u^P$ and $M^D_u$ related to the process are shown. Note that $M^P_u$ and $M^D_u$ are the changes in level from the previous process or delay of process such that they describe the accumulated evolution in the level of the tank during said process. In particular, changes in levels can occur when the production system is idle.}
    \label{fig:variable description}
\end{figure}

We note that simulations were carried out through a mixture of \texttt{Simulink} and \texttt{Stateflow} simulations. In particular, the continuous subsystems such as the reaction in process $7$ where simulated through \texttt{Simulink} based mass-balance equations.

At this point, we have a rudimentary understanding of how the system is simulated and the meaning of the random variables that are related to each process. We thus continue with some basic statistics concerning the durations of batches. For the remaining of the chapter, we will primarily present results for the duration and delays of the processes as the analysis and results are identical to those of the change in level. Namely, we shall observe that the dimension of the random vector that describes each batch (i.e. durations, delays and level changes) large enough such that no meaningful conclusion on the causal relation between random variables can be drawn. In particular, we will need a framework such as the one presented in \autoref{chap:method}, to discover such relationships.




% The data is chosen as it resembles an actual production data set but is also implemented with what at first glance seem to be fairly realistic variation and noise in measurements. Overall, the point of this example data is to exemplify what one may encounter in a real batch production system and from this try to build a model in order to predict or quantify the behavior of the system or learn hidden (causal) structure important for optimization etc.




% antager senere at der ikke er sammenhæng fra batch til batch. det er måske ok, måske ikke. anyways ser vi hvor godt vi kan forklare processerne udelukkende fra processer i samme batch



% Handler om data, hvorfor det giver mening med baggrund i dette (et mere statistisk udgangspunkt, måske er det ikke altid at man ved hvad der har effekt på hvad, og hvordan det kan kontrolleres)


% the time stamps (in hours) and level in a tank is of the most interest.

% The goal of this section is to describe how different phases of the production covary. 






% We define a set of phases/units $\mathcal{U}$ that each batch consists of. In this case, units are identified with IDs 1 through 10 (with subunits such as 3.1) described further in \autoref{tab:absolute phase ID batch count}. Then, for each unit, we define the random variable $X_u$ to be the total time a batch spends in unit $u$ i.e. the sojourn time related to unit $u$. 


% We also define the random variables $X_u^P$ and $X^D_u$ to be the duration of the actual \textit{processing} and \textit{delay} respectively such that $X_{u} = X_u^P + X_u^D$. It is also important to keep track of the level in the tank after each unit is finished, and we thus define variables $M_u$ and $M^D_u$ to be the level in the tank after unit $u$ and its associated delay respectively. As the units are executed in sequence, as is the case in this data, a simple representation of the variables can easily be visualized and is shown in \autoref{fig:variable description} below.





\section{Basic statistics}
% Initially, we present some basic statistics in  for batches and proceed to discuss the nature of the batches, removing outliers and faulty observations etc.
Before analyzing the time series in more depth and filter out (or correct) troublesome data points, we present some initial statistics on the duration of batches for each cycle. The statistics are summarized in \autoref{tab:cycle basic stats} below. We note that some difference is observed from cycle to cycle, but we choose to assume that these differences are simply a feature of the production system, such that later on, we can combine all observations across all cycles into a single dataset to be used for causal discovery.

\begin{table}[h]
    \centering
    \begin{tabular}{c|c|c|c|c|c}
        Cycle & \makecell{number of                                    \\ batches} & \makecell{mean} & \makecell{variance} & \makecell{standard\\ deviation} & \makecell{coefficient \\ of variation} \\ \hline
        A     & 66                  & 14.776 & 3.641 & 1.908 & 0.1291  \\
        B     & 64                  & 15.644 & 3.915 & 1.979 & 0.1265  \\
        C     & 61                  & 17.714 & 2.330 & 1.526 & 0.08617 \\
        D     & 60                  & 18.069 & 6.922 & 2.631 & 0.1456  \\
        E     & 60                  & 18.088 & 9.613 & 3.100 & 0.1714  \\
        F     & 63                  & 17.227 & 7.766 & 2.787 & 0.1618  \\\hline
        \makecell{Combined                                             \\ cycles} & 374               & 16.876        & 7.218                & 2.687                          & 0.1592
    \end{tabular}
    \caption{Basic batch statistics for each cycle and by combining all cycles into a single data set. The average duration of batches across cycles appear similar when taking the variance of the durations into account. We note that later, we wish to estimate the dependency between pairs of random variables whence more observations is better, as always in data science. We do however note that there appears to be a difference between especially the first three cycles and the latter ones. In particular, the variance is larger for cycles named $D$, $E$ and $F$. The source of this variation is at this point unknown however it could be seen as a feature of the dataset. Namely, if the observations are truly from the same production system, this variation could be an inherent feature of the production system which we should not remove. }
    \label{tab:cycle basic stats}
\end{table}

In the following section, we discuss a problem with some of the batches. Namely, the trailing batches, which appear to be cut-off during simulation. In this way, we shall end up with a total of 368 batches, which after some correction (see \autoref{sec:Data - production processes}) will be our final data set.




% Each batch comprises several states. These include adding materials (IDs 1 through 4), centrifugation (ID 5), product transfer (the precipitate generated from the centrifugation, ID 6), chemical reaction (ID 7), a post operation state (\textcolor{red}{Probably to let it cool down to a point where it is ready for further processing}, ID 8), Cooling of the product (ID 9), material transfer (transfer the gained product before cleaning of the reaction vessel and/or prepare for the next reaction batch, ID 10). Notice that there is a total of 374 batches throughout the 6 observed cycles.



\section{Incompleteness of trailing batches}
In this section, we shall investigate the combined dataset of $374$ batches in more detail. In particular, we shall observe some deviation from \autoref{fig:Cycle and process structure} in terms of labels of each event in the time series and how we have handled these discrepancies. Namely, by looking through the time series for each cycle, we observe entries labeled with negative processes. These, we will investigate the next section and note that from paper introducing the simulations we present here \cite{benchmark-model-to-generate-batch-process-data}, it is by design that some labels are incorrect. Their argument for this is in relation to training a robust machine learning algorithm but as this is none of our concern, we shall manually handle these in correct labels. In particular, the negative labels are initially negated to be positive instead. Hence, we observe events labeled $3$, which is not originally a part of the production system description from \autoref{fig:Cycle and process structure}. With these negative labels transformed, we count for each of the (new) process labels, how many batches are observed. E.g. how many batches are at some point observed to be undergoing process $1$ (the addition of a material). We do this to make sure that in fact every batch go through all processes from \autoref{fig:Cycle and process structure}. The result of this counting batches is presented in \autoref{tab:absolute phase ID batch count}, where the description of the recognized processes has been copied from \cite{benchmark-model-to-generate-batch-process-data}. Note that \texttt{Educt1}, \texttt{Educt2} and \texttt{Educt3} are just some (unknown) materials that we do not care about.
\begin{table}[ht]
    \centering
    \begin{tabular}{c|c|c}
        ID   & Count & Description                                     \\\hline
        1.0  & 374   & Addition of liquid raw material \texttt{Educt1} \\
        2.0  & 374   & Addition of liquid raw material \texttt{Educt2} \\
        3.0  & 181   &                                                 \\
        3.1  & 374   & Addition of liquid raw material \texttt{Educt3} \\
        3.2  & 374   & Agitation                                       \\
        4.0  & 163   &                                                 \\
        4.1  & 374   & Waiting for field operation                     \\
        4.2  & 374   & Addition of solids                              \\
        4.3  & 374   & Waiting for control operator                    \\
        5.0  & 374   & centrifugation                                  \\
        6.0  & 374   & Product transfer                                \\
        7.0  & 370   & Reaction                                        \\
        8.0  & 369   & Post reaction                                   \\
        9.0  & 369   & Cooling                                         \\
        10.0 & 368   & Material transfer
    \end{tabular}
    \caption{The number of batches across all cycles that contains at least one observation for each different process label.}
    \label{tab:absolute phase ID batch count}
\end{table}
Note that we have not included labels pertaining the cleaning operation as these will be handled separately in \autoref{sec:Data - Cleaning operations} where we also argue why we will not use these observations in the later analysis.



% As it may be of interest to investigate the correlation structure of different metrics and variables later on, it is important to understand how each of the batches across the cycles behave. Initially, when looking through the dataset, we observe a few negative phase IDs which will need investigation. However, before we do so, we check that each of the batches actually go through all the states mentioned in \cite{benchmark-model-to-generate-batch-process-data}. 

% Thus, we take the absolute value of the negative phase IDs to ease the analysis prior to the analysis of the negative phase IDs. After this is done, we observe that not all batches go through all the phases and that some seem to have extra phases not described by \cite{benchmark-model-to-generate-batch-process-data}. Namely, from \autoref{tab:absolute phase ID batch count}, we see that IDs 3 and 4 (which are not described in \cite{benchmark-model-to-generate-batch-process-data}) have significantly fewer batches going through this phase. But perhaps even more interesting is the final 4 phases where almost all batches goes through these phases.

Interestingly, the \textit{unrecognized} process labels $3$ and $4$ only occur for processes with subprocesses. We shall later observe that these labels all originate from negative process labels and that they actually correspond to delays between processes as portrayed in \autoref{fig:variable description}. For now, we however concentrate on the last four process labels $7$, $8$, $9$ and $10$. In particular, as all the other process labels (excluding $3$ and $4$) appear exactly $374$ (the number of batches in total) times, we suspect that something weird is going on with these \textit{missing} observations. As hinted to before, it turns out that the simulations have been cut off after $1100$ hours. Therefore, the trailing batch of each cycle does not complete all processes. For example, in \autoref{fig:last batch example}, we have shown the first batch of cycle A as well as the trailing batch and how the over time switch between process labels (not that for this plot, we have not negated the negative process labels)

\begin{figure}[h]
    \centering
    \includegraphics[width=0.75\linewidth]{figures/Multiple cycles data/tailing batch short.pdf}
    \caption{The first and last batch from cycle A. The horizontal colored bars corresponds to the different process labels such that time stamps labeled e.g. $3.1$ and $3.2$ fall in the same colored region. It is clear that the final batch is cut-off before finishing the last process. Furthermore, we observe that the negative process labels for these two batches only occur before the process label enters a new colored region. This hints to the negative process labels are actually delays between processes.}
    \label{fig:last batch example}
\end{figure}

From the above, it is clear that we need to remove the final batches of each cycle. Thus, we now have a total of $368$ batches. In the following section, we shall see in more detail when the negative process labels occur and make the assumption that they correspond to delays between processes. Note that the cleaning operation is not considered in the following section.






\section{Production processes}\label{sec:Data - production processes}
We now focus on the processes labelled $1$ through $10$ from \autoref{fig:Cycle and process structure}. In particular, we shall denote these processes as \textit{production} processes, as they are exactly the processes where a substance is produced or handled in some other way. Initially, we shall however focus on the first processes up to and including $4.3$. Namely, from \autoref{tab:absolute phase ID batch count}, we saw that it was these few initial processes where labels seemed to be weird.

In \autoref{fig:B_22 phase 1-4}, we have shown the \nth{22} batch of cycle B. Once again, we observe the negative process label. We notice that it is only visited once, and only at the of the process which its label corresponds to.

\begin{figure}[h]
    \centering
    \includegraphics[width=.83\linewidth]{figures/Multiple cycles data/Adding of solids/B_22 long waiting.pdf}
    \caption{The temporal evolution of process labels for batch 22 from cycle B. Only the processes pertaining to the first boxes of \autoref{fig:Cycle and process structure} are shown to easier tell what is happening.}
    \label{fig:B_22 phase 1-4}
\end{figure}

% This part of the process corresponds to events tagged with ID 1 through 10 but will initially concern itself with ID 1 through 4 as much can be learned from the data set here. In \autoref{fig:B_22 phase 1-4} an example of how the process evolves over time through the different phases is shown. Immediately, we observe something weird, namely the negative event IDs.

Continuing the investigating, we see that negative process labels occur throughout all the six cycles. Furthermore, by saving what negative process labels have occurred for each cycle, we obtain \autoref{tab:phase negative observations} where we observe a clear tendency regarding the process labels $-4.1$, $-4.2$ and $-4.3$. Namely, they only occur in cycle F. From \cite{benchmark-model-to-generate-batch-process-data}, we note that cycle F is the only phase containing wrongly labeled time points. In particular, we can conclude that the negative process labels apart from $-4.1$, $-4.2$ and $-4.3$ are not an error in the data set.

\begin{table}[h]
    \centering
    \begin{tabular}{c|c|c|c|c|c|c}
        \diagbox{Event}{Cycle} & A                    & B                    & C                    & D                    & E                    & F                    \\\hline
        -1                     & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} &                      &                      \\\hline
        -2                     &                      &                      &                      & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} \\\hline
        -3                     & \cellcolor{black!50} &                      & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} \\\hline
        -4                     &                      & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} &                      \\\hline
        -4.1                   &                      &                      &                      &                      &                      & \cellcolor{black!50} \\\hline
        -4.2                   &                      &                      &                      &                      &                      & \cellcolor{black!50} \\\hline
        -4.3                   &                      &                      &                      &                      &                      & \cellcolor{black!50} \\\hline
        -5                     & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} \\\hline
        -6                     &                      & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} \\\hline
        -7                     & \cellcolor{black!50} &                      & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} \\\hline
        -8                     & \cellcolor{black!50} &                      & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} \\\hline
        -9                     &                      &                      &                      & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} \\\hline
        -10                    &                      & \cellcolor{black!50} &                      & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50}
    \end{tabular}
    \caption{Occurrences of negative process labels. It is observed that the process labels -4.1, -4.2, -4.3 only occur in cycle F which is known to be the only cycle with wrongly labelled phases.}
    \label{tab:phase negative observations}
\end{table}

In \autoref{fig:negative 4 batches}, we have shown some of the batches which contain the process labels $-4.1$ etc. We observe that if either of the three process labels are negative, then all of them are and no corresponding positive labels occur. We shall thus assume that whenever $-4.1$, $-4.2$ or $-4.3$ is observed, it is actually just the negated process label. Correcting the data set under this assumption, we then only have negative process labels that are integer which we have summarized in \autoref{tab:phase negative observations mod} below.
\begin{figure}[H]
    \centering
    \includegraphics[width=.83\linewidth]{figures/Multiple cycles data/Adding of solids/sample negative sub 4 phases.pdf}
    \caption{13 out of the total 48 batches where at least one of the process labels -4.1, -4.2 or -4.3 were observed.}
    \label{fig:negative 4 batches}
\end{figure}

\begin{table}[H]
    \centering
    \begin{tabular}{c|c|c|c|c|c|c}
        \diagbox{Event}{Cycle} & A                    & B                    & C                    & D                    & E                    & F                    \\\hline
        -1                     & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} &                      &                      \\\hline
        -2                     &                      &                      &                      & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} \\\hline
        -3                     & \cellcolor{black!50} &                      & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} \\\hline
        -4                     &                      & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} &                      \\\hline
        -5                     & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} \\\hline
        -6                     &                      & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} \\\hline
        -7                     & \cellcolor{black!50} &                      & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} \\\hline
        -8                     & \cellcolor{black!50} &                      & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} \\\hline
        -9                     &                      &                      &                      & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50} \\\hline
        -10                    &                      & \cellcolor{black!50} &                      & \cellcolor{black!50} & \cellcolor{black!50} & \cellcolor{black!50}
    \end{tabular}
    \caption{In the modified data set, where $-4.1$, $-4.2$ and $-4.3$ have been converted their absolute value. We observe that the occurrence of negative labels is not identical from cycle to cycle. Depending on the parameters of the simulation, this could either be per happenstance on different settings of the simulation. Either way, we assume that as the simulation is based on the same production system, this variation is observed naturally. Hence, we shall not do more with these observations in terms of filtering them out or correcting them.}
    \label{tab:phase negative observations mod}
\end{table}

From \autoref{tab:phase negative observations mod}, we see that cycles $D$, $E$ and $F$ appear to contain more negative process labels. We will however assume that the cycles are simulated from the same production system such that no hyperparameters were changes. In particular, we shall assume that the observations of negative process labels occurs at random, independently of the cycle.

Furthermore, by plotting the different batches from different cycles, it is apparent that the negative process labels always occur after each process (including subprocesses) and before the next process. I.e. we only observe the label $-1$ after $1$ and before $2$. Likewise, $-3$ only occurs after both $3.1$ and $3.2$ but before $4.1$. As hinted to before, we shall thus assume that these negative process labels corresponds to delays between processes. This does make sense from a production point, but they also note in \cite{benchmark-model-to-generate-batch-process-data} that delays between operations have been implemented.

At this point, we finally have a sufficient understanding of the simulation to define a few random variables. For each main process $u\in \{1,\dots, 10\}$, we define the \textit{delay} after the process as $T^D_u$ and the associated change in level $M^D_u$. Similarly, for the actual processes $u \in \{1,\,2,\,3.1,\,3.2,\,4.1,\,\dots,\,10\}$ we have \textit{process} duration $T^P_u$ and likewise $M^P_u$. Converting the time series data to realizations of the random variables, we find that $T^P_{4.1}$, $T^P_{4.3}$ and $T^P_8$ are always constant. Referring once again to \cite{benchmark-model-to-generate-batch-process-data}, we see that indeed these processes are controlled such that the duration is 15 min, 5 min and 2 hours respectively. As these random variables are then not really random but constant, we exclude them from our analysis from this point onward. Note that the delays $T^D_u$ have an atom at $0$ since there is a possibility that there is no delay between processes.

\begin{figure}[H]
    \centering
    \includegraphics[width=\linewidth]{figures/Multiple cycles data/Adding of solids/hisstograms w atoms.png}
    \caption{Histograms of all random variables $T^D_u$ and $T^P_u$ that are non-constant i.e. not controlled to be a fixed amount of time. The orange bars for $T^D_u$ signify the occasions where no delay after process $u$ took place. We observe that depending on the process, a delay is more or less common. In particular after process $5$, there seem to a delay often whereas a delay of process $10$ is very rare.}
    \label{fig:histogram production durations}
\end{figure}

In \autoref{fig:histogram production durations}, we have shown histograms of frequencies for each of these random variables. We note that for the distribution of observations appear to be unimodal i.e. it does not appear as if they are a mixture of distributions. This is important, as it further strengthens our assumption that the hyperparameters of the simulation where the same for all cycles. In particular, the delays (when disregarding the atom at $0$) do not appear as if they originated from different distributions as then we would likely have observed clusters for each of the cycles.

In the next section, we shall further examine the random variables in terms of the correlation structure of the observations. However, we first present some basic statistics of the random variables in \autoref{tab:data variation and covariance} for each cycle.
\begin{table}[ht]
    \centering
    \begin{tabular}{c|cccccc}
        Cycle                                                  & A       & B       & C       & D      & E      & F      \\\hline
        $\widehat{\mathbb{E}\left[\sum T^P_u\right]}$          & 13.993  & 13.898  & 15.343  & 14.471 & 14.589 & 14.418 \\\hline
        $\widehat{\text{Var}\left(\sum T^P_u\right)}$          & 0.95636 & 0.46587 & 0.76111 & 4.9589 & 4.2678 & 5.3545 \\\hline
        $\sum \widehat{\text{Var}\left(T^P_u\right)}$          & 0.50590 & 0.31182 & 0.36667 & 1.8322 & 1.5788 & 1.9696 \\\hline
        $\widehat{\mathbb{E} \left[\sum T^D_u\right]}$         & 0.96398 & 1.9402  & 2.4503  & 3.6050 & 3.7390 & 3.0041 \\\hline
        $\widehat{ \text{Var} \left(\sum T^D_u\right)}$        & 0.31843 & 0.39117 & 0.90187 & 1.2468 & 1.2787 & 1.0462 \\\hline
        $\sum \widehat{\text{Var}\left(T^D_u\right)}$          & 0.34921 & 0.53198 & 0.74914 & 1.4357 & 1.2454 & 1.3099 \\\hline
        $\widehat{\mathbb{E} \left[\sum T^P_u + T^D_u\right]}$ & 14.957  & 15.838  & 17.793  & 18.076 & 18.328 & 17.422 \\\hline
        $\widehat{\text{Var} \left(\sum T^P_u + T^D_u\right)}$ & 1.1500  & 1.1352  & 1.7983  & 7.0000 & 5.7086 & 5.0103
    \end{tabular}
    \caption{Mean and variance overview of each of the time related variables $T^P_u$ and $T^D_u$. A clear difference of variance is observed between cycles $A-C$ and $D-F$. Furthermore, the durations $T^D_u$ clearly show that the total variation is accounted for by the variance of the individual durations. The contrary holds true for the delays $T^D_u$.}
    \label{tab:data variation and covariance}
\end{table}
From the table, we observe that the average total durations (excluding delays) of batches are approximately the same. However, the variance of the sum of durations is significantly larger for the cycles $D$, $E$ and $F$. What causes this difference in variation is however unknown. Ideally, in a real world application, one should investigate this further. On could argue that cycles $A-C$ and $D-F$ should then be treated separately and indeed the variance for the accumulated delay during a batch exhibit the same behavior. Namely, the delays also seem to have a larger variance in the later three cycles. We shall however treat all the batches simultaneously in this thesis by arguing that although there is a clear difference in variation, the underlying causal structure of the processes is assumed to be the same. In particular, we could not infer from the simulation study \cite{benchmark-model-to-generate-batch-process-data} that the cycles should have been based on different hyperparameters resulting in the below difference of variances. Furthermore, we note that the difference between the variation in the accumulated duration and the sum of process durations i.e. $\widehat{\text{Var}\left(\sum T^P_u\right)} - \sum \widehat{\text{Var}\left(T^P_u\right)}$ indicate that the durations of the processes are not unrelated. Thus, in the next section we shall investigate the correlation structure of the variables. Finally, we note that the same difference for durations does not indicate a relationship. However, the missing covariances might just cancel each other out. Hence, we do not yet conclude anything regarding their causal structure.















\subsection{Correlation structure of durations and delays}
In this section, we proceed with investigating the correlation between pairs of the random variables. Based on the observations, we quickly compute a correlation matrix as observed in \autoref{fig:Data - correlation matrix all times}.
\begin{figure}[H]
    \centering
    \includegraphics[width=.9\linewidth]{figures/Multiple cycles data/Correlation matrix production and delays.png}
    \caption{Estimated correlation matrix of the random variables $T^P_u$ and $T^D_u$.}
    \label{fig:Data - correlation matrix all times}
\end{figure}
We immediately notice that the durations of the processes appear to be positively correlated. The fact that there exists strong correlations is not surprising when considering \autoref{tab:data variation and covariance} where we observed that the variation of the sum of durations was much larger than the sum of individual variances. The only other immediately interesting observation that we make from the above figure is the large correlation between $T^D_7$ and $T^P_9$. This means that there is a positive linear relationship between the delay after the reaction process $7$ and the time it takes to cool the tank (process $9$).

To assess the significance of these correlations, we performed a permutation test. Namely, by randomly permuting the observations of each random variable and recomputing the correlation matrix, we see if the new correlation coefficient is numerically larger than the one we computed from the original data. Repeating this multiple times (e.g. 10,000 times), we obtain an estimate of the probability of observing a correlation coefficient, numerically larger than the one we computed in \autoref{fig:Data - correlation matrix all times}.
\begin{figure}[ht]
    \centering
    \includegraphics[width=.9\linewidth]{figures/Multiple cycles data/Permutation test rho 10 mil.png}
    \caption{Permutation test with significance level $\alpha = 0.05$ based on 10,000 permutations. The diagonal elements have been set to $0$ as it does not make sense to test the correlation between a random variable and itself.}
    \label{fig:Data - perm test result}
\end{figure}
In particular, the null hypothesis is that there is no correlation between a pair of random variables. This is because when the samples are reshuffled independently of each other, the underlying assumption is that the random variables are independent of each other and hence has correlation $0$. In \autoref{fig:Data - perm test result} we have shown a binary matrix for when the p-value was observed to be less than $0.05$ i.e. significant results on a $5\%$ significance level. We observe that many of the correlations appear to significant which is somewhat contradictory to what we would expect from such a production system. However, as we are performing multiple test, we really should correct for this in some way. Choosing a conservative approach through the Bonferroni correction, we get far fewer significant results as observed in \autoref{fig:Data - perm test result - Bonferroni}. Once again, we have removed the diagonal elements.

\begin{figure}[ht]
    \centering
    \includegraphics[width=.9\linewidth]{figures/Multiple cycles data/Permutation test rho 10 mil - bonferoni.pdf}
    \caption{The permutation test with Bonferroni corrected significance level. Many of the significant correlations disappear however when plotting e.g. $T^D_1$ vs $T^D_2$ we see that the correlation does not stem from a linear relationship. In particular, from \autoref{fig:time vs time all}, we observe that the joint distribution is more of an \textit{L}-shape. We shall thus later investigate other measures of similarity than correlation to capture such non-linear tendencies}
    \label{fig:Data - perm test result - Bonferroni}
\end{figure}

Suppose now that we instead did not know what part of a process what the duration and what was a delay. In particular, we define the total duration of a process as $T_u = T^P_u + T^D_u$. Note that for $T_3$ and $T_4$, we extend this definition slightly such that $T_3 = T^P_{3.1} + T^P_{3.2} + T^D_{3}$ and $T_4 = T^P_{4.1} + T^P_{4.2} + T^P_{4.3} + T^D_{4}$ (although $T^P_{4.1}$ and $T^P_{4.3}$ can be disregarded as they are constant and hence irrelevant when computing the correlation). Using only the cumulated random variables, we observe a much simpler correlation structure as shown in \autoref{fig:Data - combined duration and delay}. However, we also seem to lose much of the information that was otherwise visible in \autoref{fig:Data - correlation matrix all times}.

\begin{figure}[H]
    \centering
    \includegraphics[width=.7\linewidth]{figures/Multiple cycles data/Correlation matrix collapsed phases.pdf}
    \caption{Correlation matrix for combined process durations $T_u$. The strong correlations that we observed previously appear to be lost. In particular, it is no longer clear what durations influence each other if any. Thus, we conclude that at least in the case of linear relations between durations, the extra information regarding when the system is idle due to a delay, is very important if we want to have any change of inferring anything useful about the causal structure of the production system.}
    \label{fig:Data - combined duration and delay}
\end{figure}

As a final remark, we have shown in \autoref{fig:Data - process and the next process scatter} the duration of a process $T_u$ and the process that follows immediately after $T_{u+1}$. Although the correlations in \autoref{fig:Data - combined duration and delay} did not appear as informative as in \autoref{fig:Data - correlation matrix all times}, there might still be some useful observations to be made from the joint raw observations. Note that Cycle $1$ corresponds to Cycle A and so on. From the below figure, it is clear that the duration of a process is not well-described based solely on the previous process. However, we do observe an interesting behavior in $T_2$ vs $T_1$ and $T_{10}$ vs $T_9$. Namely, for $T_2$ and $T_1$, $T_1$ appear to be larger in the first $3$ cycles while $T_2$ appears to be larger in the final three cycles. This results in the \textit{L}-shape observed. A similar observation is made between $T_{10}$ and $T_9$. From \autoref{tab:phase negative observations mod}, we see that this coincides with the existence of delays in the cycles respectively. Furthermore, from \autoref{fig:histogram production durations}, the durations often last much longer than the actual duration of the process, such that the delay dominates the total duration of the process.

\begin{figure}[H]
    \centering
    \includegraphics[width=\linewidth]{figures/Multiple cycles data/phase scatter vs next phase.png}
    \caption{Total process durations $T_u$ plotted against the next process $T_{u+1}$. In some cases, there seem to be a difference from cycle to cycle. Especially in $T_2$ vs $T_1$ and $T_{10}$ vs $T_9$.}
    \label{fig:Data - process and the next process scatter}
\end{figure}

For the sake of completeness, we have in the appendix, \autoref{fig:time vs time all}, \autoref{fig:time vs level all} and \autoref{fig:level vs level all} plotted all variables against each other. Although clear relations can be observed between some pairs of random variables it is unclear how e.g. durations and delays (and the related level changes) propagate through the system if they even do so. In \autoref{chap:method}, we will discuss a method for discovering such relations, but first, we comment on the cleaning operations that until this point has been left out.


% Check at eventID altid er kronologisk stigende, absolut værdi (med undtagelse for 3 og 4, der gør lidt tilbage grundet waiting time)

% Peaks i e.g. 1, kommer det fra en specifik cycle?

% sammenhæng med fyldningsniveau?

% correlaiton diagrammer

% Betyder delay på 7 (ID -7) at der bliver produceret mere? Eller er det bare den er færdig og man så venter til næste operation?

% Skal man måske prøve at modellere sig ud af korrelationen? Måske ved at kigge på fyldningsniveauet, da det nok beskriver en del



\section{Cleaning operations}\label{sec:Data - Cleaning operations}
As per \autoref{fig:Cycle and process structure}, after each batch, the tank in which the process has taken place is to be cleaned. However, from inspection of the data, we observe that only for cycles $A$ and $B$ is this true. Namely, for cycles $C$ through $F$, the tank is not cleaned after each batch. This, along with some basic statistics regarding the duration of the cleaning operation is summarized in \autoref{tab:cycle cleansing stats stats}.

\begin{table}[ht]
    \centering
    \begin{tabular}{c|c|c|c|c|c|c|c}
        Cycle & \makecell{number of                                                     \\cleanses} & \makecell{min}   & \makecell{max}   & \makecell{sample\\mean} & \makecell{sample\\variance} & \makecell{sample\\standard\\deviation} & CV \\ \hline
        A     & 65                  & 1.113 & 3.067 & 1.917 & 0.269   & 0.518  & 0.270  \\
        B     & 63                  & 1.324 & 1.751 & 1.566 & 0.00883 & 0.0939 & 0.0600 \\
        C     & 9                   & 1.544 & 3.306 & 2.153 & 0.277   & 0.526  & 0.245  \\
        D     & 10                  & 1.474 & 2.009 & 1.581 & 0.0212  & 0.146  & 0.0922 \\
        E     & 10                  & 0.827 & 1.584 & 1.465 & 0.0462  & 0.215  & 0.147  \\
        F     & 10                  & 0.748 & 1.610 & 1.466 & 0.0595  & 0.244  & 0.166
    \end{tabular}
    \caption{Per cycle cleansing statistics. We observe that cycles $A$ and $B$ have many more cleaning processes taking place than cycles $C-F$. Also, the variation in cycles $A$ and $C$ is much larger than for the other cycles. These observations indicate that the cleaning operations from the different cycles have not been simulated from the same hyperparameters. This apparent inequality between the cycles is the primary reason for why we have not chosen to use them in our further analysis of the production system.}
    \label{tab:cycle cleansing stats stats}
\end{table}


The most notable differences from cycle to cycle are the number of cleanses as each cycle have approximately the same number of batches as seen in \autoref{tab:cycle basic stats}. For the first two cycles, the cleanses seem to be in between every batch, which is indeed the case. Furthermore, although the cleanses are between every batch for cycles A and B, the variances are extremely different. Also, we observe that cycles $A$ and $C$ have much larger variation than the remaining cycles. With these observations, we hypothesize that the cleaning operations have not been simulated based on the same settings whence we will not consider these processes in our further analysis.

Furthermore, histograms of the durations of cleaning processes for each cycle in \autoref{fig:cycle cleaning histograms} show that although cycle $B$ has many more cleanses, the distribution is somewhat comparable to those of cycles $D-F$ as the durations are approximately centered around $1.55$ with similar interquartile range.

\begin{figure}[ht]
    \centering
    \includegraphics[width=0.8\linewidth]{figures/Multiple cycles data/Cleaning batches histograms.png}
    \caption{Each of the 6 cycles, cleaning operations histograms.}
    \label{fig:cycle cleaning histograms}
\end{figure}

In the appendix, \autoref{fig:cycle cleaning time series single} and \autoref{fig:cycle cleaning time series}, we have shown how a cleaning operation goes through each of the subprocesses. Indeed, for cycles $C-F$ the cleaning process is only carried out every so often as summarized in \autoref{tab:cycle cleaning prob}. From \autoref{fig:cycle cleaning time series}, the cleaning processes appear to be carried out between a random number of batches. In the remaining part of this section, we shall investigate this observation for the latter four cycles with some simple tests.

\begin{table}[h]
    \centering
    \begin{tabular}{c|c}
        Cycle & \makecell{Percentage cleaning processes\\ after batches} \\ \hline
        A     & 100.00      \\
        B     & 100.00      \\
        C     & 15.00       \\
        D     & 16.95       \\
        E     & 16.95       \\
        F     & 16.13
    \end{tabular}
    \caption{Per cycle, how often a batch is followed by a cleaning process.}
    \label{tab:cycle cleaning prob}
\end{table}



% From the above observation of like modes one may want to observe the histogram of the combined set of cleaning times. In particular, under the hypothesis that the durations are actually from the same probability distributions and realized independently within each cycle a histogram of all the observations are of interest and is shown in \autoref{fig:cycle cleaning histograms combined} below.


% \begin{figure}[H]
%     \centering
%     \includegraphics[width=0.8\linewidth]{figures/Multiple cycles data/Cleaning batches histograms combined.png}
%     \caption{Combined cleaning operations histograms.}
%     \label{fig:cycle cleaning histograms combined}
% \end{figure}


% Finally, to get a better overview of the irregularities is the number of cleaning periods (mostly concerning cycles C through F), each cleaning operation is shown in the following \autoref{fig:cycle cleaning time series}. The vertical shaded rectangles signify the period in which a cleaning operation is taking place. Furthermore, the event IDs are shown but to get a clearer view on what is going on, a single rectangle (zoomed in) is shown in \autoref{fig:cycle cleaning time series single}.




% It is observed that the observations marked with red in figure \ref{fig:cycle cleaning time series} occur exactly when that specific cleaning operation does not go to the state 11.0 after the flush of the tank (event ID 11.5) and vice versa. It is hard to conclude what this may mean, but the cleaning being in state 11.0 may indicate that the system is idle before continuing the next batch like what is observed from the other steps of the process flow. Also, it is noted that while the red dots occur nothing else is happening according to the dataset.


% From a modelling point of view, the cycles C through F can be thought of as the cleansing operation having a probability of not happening or equivalently as having a duration of 0. It is thus of interest to observe what the probability of cleaning after an operation is. From \autoref{tab:cycle basic stats} and \autoref{tab:cycle cleansing stats stats}, we that indeed for cycles A and B, the probability is 100 \% when disregarding the possibility of cleaning after the final batch. Hence, we see that for the remaining cycles, the probabilities of cleaning the tank after an operation are as in \autoref {tab:cycle cleaning prob}


In particular, let $C_i$ denote the indicator of whether the $i$th batch is followed by a cleaning of the tank or not. We shall then investigate whether the next batch is also cleaned or not. I.e. at a lag $1$, if the variables $C_i$ are associated. In particular, we shall use Fisher's exact test with the alternative hypothesis being two-sided. We use the \texttt{scipy} implementation \texttt{stats.fisher_exact}. The results are summarized in \autoref{tab:Contingency table for Cycle C-F}. Indeed, we observe that the results are non-significant on a $5\%$ significance level. Repeating the tests for lags up to and including $10$ we observe no significant results either. More sophisticated tests could be carried out to test if using e.g. the previous $5$ $C_i$ is predictive of whether the next batch is followed by a cleaning process. However, as we shall not use this later, we end our discussion of the cleaning processes and note that in the remaining of the thesis, they have been excluded from the dataset.

% It is then of interest if the next batch is followed by a cleaning given whether the current batch is followed by a cleaning. In particular, we count for each of the cycles the transitions which are shown in the following tables. Notice that the number of observations is two less than the total number of batches within each specific cycle. This is due to the last batch is never followed by a cleaning (nor is the first batch superseded by a cleaning procedure) which results in one less observation and also due to the fact that we are logging transitions and hence lose another observation.

% To test for randomness, a Chi-squared test is carried out on each of the cycles to check for independence. It is observed all the cycles exhibit independence between the groups i.e. there is no statistical evidence for information is gained about if the next batch is followed by a cleaning operation given whether the current batch is followed by a cleaning operation.

\begin{table}[ht]
    \begin{subtable}{.5\linewidth}
        \centering
        \begin{tabular}{c|c c}
            \diagbox{$C_i$}{$C_{i+1}$} & No & Yes \\ \hline
            No                         & 41 & 9   \\
            Yes                        & 9  & 0
        \end{tabular}
        \caption{Cycle C, $p=0.3293$}
        \label{tab:cycle C Contingency table}
    \end{subtable}%
    \begin{subtable}{.5\linewidth}
        \centering
        \begin{tabular}{c|c c}
            \diagbox{$C_i$}{$C_{i+1}$} & No & Yes \\ \hline
            No                         & 41 & 8   \\
            Yes                        & 7  & 2
        \end{tabular}
        \caption{Cycle D, $p=0.6456$}
        \label{tab:cycle D Contingency table}
    \end{subtable}
    \begin{subtable}{.5\linewidth}
        \centering
        \begin{tabular}{c|c c}
            \diagbox{$C_i$}{$C_{i+1}$} & No & Yes \\ \hline
            No                         & 41 & 7   \\
            Yes                        & 7  & 3
        \end{tabular}
        \caption{Cycle E, $p=0.3532$}
        \label{tab:cycle E Contingency table}
    \end{subtable}%
    \begin{subtable}{.5\linewidth}
        \centering
        \begin{tabular}{c|c c}
            \diagbox{$C_i$}{$C_{i+1}$} & No & Yes \\ \hline
            No                         & 41 & 9   \\
            Yes                        & 9  & 1
        \end{tabular}
        \caption{Cycle F, $p=1.0000$}
        \label{tab:cycle F Contingency table}
    \end{subtable}
    \caption{Contingency table for Cycle C-F at lag 1. No significant results are observed and repeating for lags larger than $1$ we do not conclude otherwise.}
    \label{tab:Contingency table for Cycle C-F}
\end{table}

% Thus collecting the observations from all the last four cycles, we may want to model the atom of the cleaning procedure independently of the previous batch and with a probability of $0.8375$ corresponding to the cleaning procedure only being carried out $16,25$\% of cases.

% Finally, we show the autocorrelation function for each the four cycles C-F in \autoref{fig:cycle cleaning ACF} and note that all the ACF stay within the 95\% confidence interval.

% \begin{figure}[h]
%     \centering
%     \includegraphics[width=0.8\linewidth]{figures/Multiple cycles data/Cleaning Autocorrelation.png}
%     \caption{Autocorrelation function for each of the final 4 cycles. As can also be seen from this there seem to be no information to be gained of $C_i$ from $C_{i-1}$.}
%     \label{fig:cycle cleaning ACF}
% \end{figure}

\end{document}


% There is a relationship between the red dots and when the cleaning does not \textit{return} to state 11.0 -> probably no


% Correlationssky mellem delay og % filled




% 1 og -1 sammen osv -> ny korrelationsmatrix -> DONE

% Binært billede af korrelationsmatrix om hvad der er med ud fra threshhold T (varirer lidt om hvad der kan give mening -> absolutværdi af korrelation obv.))

% plot tider for operationer over for hinanden: O1 vs O2, O2 vs O3 -> DONE



% Bo skal sende Claras PhD. vedrørende togmodeller

% MODEL: baseret på threshhold for en phase, kan gå to veje, MPH* mmodel i den ene (måske) , MPH* i den anden + hale (eksponentiel)


% CME ILT TELEK

% undersøg delay propagation - artikler


% se på kurver om der sker noget specielt under negative event med fyldningsniveauer